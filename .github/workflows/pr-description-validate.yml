name: Validate PR description is not empty

on:
  pull_request:
  issue_comment:

jobs:
  check-description:
    runs-on: ubuntu-latest

    steps:
    - name: Check out the repository
      uses: actions/checkout@v4
    
    - name: Check PR description
      id: validate_description_step
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const pr = context.payload.pull_request;
          if (!pr || !pr.body || pr.body.trim().length === 0) {
            echo "pr_description_check_passed=false" >> $GITHUB_OUTPUT
            throw new Error('Описание pull request не может быть пустым.');
          }
          echo "pr_description_check_passed=true" >> $GITHUB_OUTPUT

    - name: Find Comment
      uses: peter-evans/find-comment@v3
      id: fc
      with:
        issue-number: ${{ github.event.pull_request.number }}
        comment-author: 'github-actions[bot]'
        body-includes: |
          ⚠️ **Пожалуйста, добавь описание к pull request.**

    - name: Update comment with validation failed statement
        if: ${{ steps.validate_description_step.outputs.pr_description_check_passed == 'false' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: `
            ⚠️ **Пожалуйста, добавь описание к pull request.**

            Описание pull request помогает лучше понять изменения, которые вы вносите, облегчает процесс ревью и поиска причин инцидентов.
            Описание должно содержать **причину** изменений: какую **проблему** решаем, **зачем** делаем изменение, а не что изменилось.
            Причина может быть в описании issue или в треде, тогда достаточно указать ссылку.

            * Добавь ссылку на issue или тред, в котором раскрыта причина изменения
            * Если требуется, коротко опиши зачем делаешь изменение, какую проблему решаешь

            Спасибо!
          `.split('\n').map(line => line.trim()).join('\n')

    - name: Update comment with check succeeded statement
        if: ${{ github.event.issue.pull_request }} && ${{ steps.validate_description_step.outputs.pr_description_check_passed == 'true' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.fc.outputs.comment-id }}
          edit-mode: replace
          body: `
            -- Проверка на непустое описание ПР --
            :white_check_mark: Спасибо, что добавил описание :heart:
          `.split('\n').map(line => line.trim()).join('\n')